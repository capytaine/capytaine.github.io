<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Advanced cookbook &#8212; capytaine 2.3.dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css?v=e9a64e30" />
    <script src="../_static/documentation_options.js?v=7906c0ec"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/proof.js?v=41e9dd12"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Developer manual" href="../developer_manual/index.html" />
    <link rel="prev" title="Intermediate cookbook" href="B_intermediate_cookbook.html" />
    <script defer data-domain="capytaine.github.io" src="https://plausible.io/js/script.js"></script>
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  


  </head><body>
  

    <div class="document">
<div id="new-doc-warning-banner" style="width:100%; background-color:#ADD8E6; text-align: center;">This page is part of the documentation of the development version 2.3 of Capytaine.<br><a href="https://capytaine.github.io/stable/">Latest stable version is available here.</a></div>
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="advanced-cookbook">
<h1><a class="toc-backref" href="#id1" role="doc-backlink">Advanced cookbook</a><a class="headerlink" href="#advanced-cookbook" title="Link to this heading">¶</a></h1>
<p>This page contains several examples of Capytaine’s advanced features, about the
fine control of the internal of the solver.
The scripts can be downloaded individually as Python files from the <a class="reference external" href="https://github.com/capytaine/capytaine/tree/v2.3.dev/docs/user_manual/examples/">Github folder with examples for version 2.3.dev</a>.</p>
<nav class="contents" id="content">
<p class="topic-title">Content</p>
<ul class="simple">
<li><p><a class="reference internal" href="#advanced-cookbook" id="id1">Advanced cookbook</a></p>
<ul>
<li><p><a class="reference internal" href="#c1-parallel-computation-with-joblib" id="id2">C1. Parallel computation with Joblib</a></p></li>
<li><p><a class="reference internal" href="#c2-direct-or-indirect-boundary-integral-equation" id="id3">C2. Direct or indirect boundary integral equation</a></p></li>
<li><p><a class="reference internal" href="#c3-single-precision-computations" id="id4">C3. Single precision computations</a></p></li>
<li><p><a class="reference internal" href="#c4-using-an-iterative-solver" id="id5">C4. Using an iterative solver</a></p></li>
<li><p><a class="reference internal" href="#c5-plot-the-influence-matrix" id="id6">C5. Plot the influence matrix</a></p></li>
<li><p><a class="reference internal" href="#c6-toeplitz-matrix-of-an-axisymmetric-buoy" id="id7">C6. Toeplitz matrix of an axisymmetric buoy</a></p></li>
<li><p><a class="reference internal" href="#c7-hierarchical-matrices-with-preconditionning" id="id8">C7. Hierarchical matrices with preconditionning</a></p></li>
<li><p><a class="reference internal" href="#c8-compare-two-implementations-of-the-green-function" id="id9">C8. Compare two implementations of the Green function</a></p></li>
<li><p><a class="reference internal" href="#c9-use-a-custom-green-function" id="id10">C9. Use a custom Green function</a></p></li>
<li><p><a class="reference internal" href="#c10-implementation-of-a-gpu-custom-linear-solver" id="id11">C10. Implementation of a GPU Custom Linear Solver</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="c1-parallel-computation-with-joblib">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">C1. Parallel computation with Joblib</a><a class="headerlink" href="#c1-parallel-computation-with-joblib" title="Link to this heading">¶</a></h2>
<p>TODO</p>
</section>
<section id="c2-direct-or-indirect-boundary-integral-equation">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">C2. Direct or indirect boundary integral equation</a><a class="headerlink" href="#c2-direct-or-indirect-boundary-integral-equation" title="Link to this heading">¶</a></h2>
<p>TODO</p>
</section>
<section id="c3-single-precision-computations">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">C3. Single precision computations</a><a class="headerlink" href="#c3-single-precision-computations" title="Link to this heading">¶</a></h2>
<p>TODO</p>
</section>
<section id="c4-using-an-iterative-solver">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">C4. Using an iterative solver</a><a class="headerlink" href="#c4-using-an-iterative-solver" title="Link to this heading">¶</a></h2>
<p>TODO</p>
</section>
<section id="c5-plot-the-influence-matrix">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">C5. Plot the influence matrix</a><a class="headerlink" href="#c5-plot-the-influence-matrix" title="Link to this heading">¶</a></h2>
<p>This example plots the influence matrix for an horizontal cylinder.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cpt</span>

<span class="c1"># Generate the mesh of a cylinder</span>
<span class="n">cylinder</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="p">(</span>
        <span class="n">mesh</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">mesh_horizontal_cylinder</span><span class="p">(</span>
            <span class="n">length</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="p">))</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BasicMatrixEngine</span><span class="p">()</span>
<span class="n">green_function</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">Delhommeau</span><span class="p">()</span>

<span class="n">S</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">build_matrices</span><span class="p">(</span>
    <span class="n">cylinder</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cylinder</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
    <span class="n">free_surface</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">water_depth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
    <span class="n">wavenumber</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">green_function</span><span class="o">=</span><span class="n">green_function</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Plot the absolute value of the matrix S</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">S</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$|S|$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="c6-toeplitz-matrix-of-an-axisymmetric-buoy">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">C6. Toeplitz matrix of an axisymmetric buoy</a><a class="headerlink" href="#c6-toeplitz-matrix-of-an-axisymmetric-buoy" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cpt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine.io.xarray</span>

<span class="n">cpt</span><span class="o">.</span><span class="n">set_logging</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

<span class="c1"># Profile of the axisymmetric body</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># Generate the mesh and display it with VTK.</span>
<span class="n">buoy</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="p">(</span>
    <span class="n">mesh</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">AxialSymmetricMesh</span><span class="o">.</span><span class="n">from_profile</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">z_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">nphi</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">buoy</span><span class="o">.</span><span class="n">add_translation_dof</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Heave&quot;</span><span class="p">)</span>
<span class="n">buoy</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Set up problems</span>
<span class="n">omega_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">problems</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpt</span><span class="o">.</span><span class="n">RadiationProblem</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">buoy</span><span class="p">,</span> <span class="n">radiating_dof</span><span class="o">=</span><span class="s1">&#39;Heave&#39;</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">omega</span> <span class="ow">in</span> <span class="n">omega_range</span><span class="p">]</span>

<span class="c1"># Solve the problems using the axial symmetry</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">HierarchicalToeplitzMatrixEngine</span><span class="p">())</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_all</span><span class="p">(</span><span class="n">problems</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">capytaine</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">xarray</span><span class="o">.</span><span class="n">assemble_dataset</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Plot results</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">omega_range</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;added_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">radiating_dof</span><span class="o">=</span><span class="s1">&#39;Heave&#39;</span><span class="p">,</span>
                              <span class="n">influenced_dof</span><span class="o">=</span><span class="s1">&#39;Heave&#39;</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Added mass&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">omega_range</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;radiation_damping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">radiating_dof</span><span class="o">=</span><span class="s1">&#39;Heave&#39;</span><span class="p">,</span>
                                     <span class="n">influenced_dof</span><span class="o">=</span><span class="s1">&#39;Heave&#39;</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Radiation damping&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;omega&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="c7-hierarchical-matrices-with-preconditionning">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">C7. Hierarchical matrices with preconditionning</a><a class="headerlink" href="#c7-hierarchical-matrices-with-preconditionning" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cpt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>

<span class="n">radius</span> <span class="o">=</span> <span class="mf">2.</span>
<span class="n">spacing</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">nb_cols</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">nb_rows</span> <span class="o">=</span> <span class="mi">14</span>

<span class="n">omega</span> <span class="o">=</span> <span class="mf">1.</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nb_cols</span><span class="p">)</span><span class="o">*</span><span class="n">spacing</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nb_rows</span><span class="p">)</span><span class="o">*</span><span class="n">spacing</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">mesh_sphere</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                                                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                                                <span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
    <span class="n">body</span><span class="o">.</span><span class="n">keep_immersed_part</span><span class="p">()</span>
    <span class="n">body</span><span class="o">.</span><span class="n">add_translation_dof</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Heave&#39;</span><span class="p">)</span>

<span class="c1"># Dense problem setup and solution</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving dense problem&#39;</span><span class="p">)</span>
<span class="n">all_bodies</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="o">.</span><span class="n">join_bodies</span><span class="p">(</span><span class="o">*</span><span class="n">bodies</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;joined bodies&quot;</span><span class="p">)</span>
<span class="n">problems</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpt</span><span class="o">.</span><span class="n">RadiationProblem</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">all_bodies</span><span class="p">,</span> <span class="n">radiating_dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">all_bodies</span><span class="o">.</span><span class="n">dofs</span><span class="p">]</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">()</span>
<span class="n">dresults</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_all</span><span class="p">(</span><span class="n">problems</span><span class="p">)</span>
<span class="n">ddata</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">assemble_dataset</span><span class="p">(</span><span class="n">dresults</span><span class="p">)</span>


<span class="c1"># Hierarchical problem setup</span>
<span class="n">all_bodies</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="o">.</span><span class="n">cluster_bodies</span><span class="p">(</span><span class="o">*</span><span class="n">bodies</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;clustered bodies&quot;</span><span class="p">)</span>
<span class="n">problems</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpt</span><span class="o">.</span><span class="n">RadiationProblem</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">all_bodies</span><span class="p">,</span> <span class="n">radiating_dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">all_bodies</span><span class="o">.</span><span class="n">dofs</span><span class="p">]</span>


<span class="n">cpt</span><span class="o">.</span><span class="n">set_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>  <span class="c1"># prints the number of iterations</span>
<span class="c1"># Hierarchical solve, with preconditioner</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving hierarchical problem with preconditioner&#39;</span><span class="p">)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">sparse_engine</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">HierarchicalPrecondMatrixEngine</span><span class="p">(</span><span class="n">ACA_distance</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">ACA_tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">sparse_engine</span><span class="p">)</span>
<span class="n">presults</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_all</span><span class="p">(</span><span class="n">problems</span><span class="p">)</span>
<span class="n">tP</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">assemble_dataset</span><span class="p">(</span><span class="n">presults</span><span class="p">)</span>

<span class="c1"># Hierarchical solve, no preconditioner</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving hierarchical problem without preconditioner&#39;</span><span class="p">)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">sparse_engine</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">HierarchicalToeplitzMatrixEngine</span><span class="p">(</span><span class="n">ACA_distance</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">ACA_tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">sparse_engine</span><span class="p">)</span>
<span class="n">hresults</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_all</span><span class="p">(</span><span class="n">problems</span><span class="p">)</span>
<span class="n">tNP</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="c1"># The clustering process changes the order of the bodies with respect to</span>
<span class="c1"># the one in list &#39;bodies&#39;. The correspondence with keys is maintained correct.</span>
<span class="c1"># However, if one wants to go back to the initial ordering, the following</span>
<span class="c1"># lines can be used.</span>

<span class="n">ordered_dofs_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
    <span class="n">ordered_dofs_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">body</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;__&#39;</span> <span class="o">+</span> <span class="n">dofkey</span> <span class="k">for</span> <span class="n">dofkey</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">dofs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="p">]</span>
<span class="n">reordered_dofs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radiating_dof&#39;</span><span class="p">:</span> <span class="n">ordered_dofs_names</span><span class="p">,</span>
                  <span class="s1">&#39;influenced_dof&#39;</span><span class="p">:</span> <span class="n">ordered_dofs_names</span><span class="p">}</span>

<span class="n">reordered_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">reordered_dofs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error = &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">presults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sources</span> <span class="o">-</span> <span class="n">hresults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sources</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time with preconditioner = &#39;</span><span class="p">,</span> <span class="n">tP</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time without preconditioner = &#39;</span><span class="p">,</span> <span class="n">tNP</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;added_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">reordered_data</span><span class="p">[</span><span class="s1">&#39;added_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;added_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dense&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;HP, reordered&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;HP, before reordering&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Added mass matrix&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="c8-compare-two-implementations-of-the-green-function">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">C8. Compare two implementations of the Green function</a><a class="headerlink" href="#c8-compare-two-implementations-of-the-green-function" title="Link to this heading">¶</a></h2>
<p>This is an example of comparison of two implementations of the Green function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cpt</span>

<span class="n">cpt</span><span class="o">.</span><span class="n">set_logging</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

<span class="c1"># Generate body</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">mesh_horizontal_cylinder</span><span class="p">(</span>
    <span class="n">length</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.01</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">body</span><span class="o">.</span><span class="n">add_translation_dof</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Heave&quot;</span><span class="p">)</span>

<span class="n">test_matrix</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;omega&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="s1">&#39;radiating_dof&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">dofs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="s1">&#39;water_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]</span>
<span class="p">})</span>

<span class="n">green_functions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cpt</span><span class="o">.</span><span class="n">Delhommeau</span><span class="p">(</span><span class="n">gf_singularities</span><span class="o">=</span><span class="s2">&quot;low_freq&quot;</span><span class="p">),</span>
        <span class="c1"># cpt.Delhommeau(gf_singularities=&quot;high_freq&quot;),  # For this problem, more difficult to converge</span>
        <span class="n">cpt</span><span class="o">.</span><span class="n">HAMS_GF</span><span class="p">(),</span>
        <span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">green_functions</span><span class="p">:</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span><span class="n">green_function</span><span class="o">=</span><span class="n">gf</span><span class="p">)</span><span class="o">.</span><span class="n">fill_dataset</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">gf</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">green_functions</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;added_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">water_depth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Infinite depth </span><span class="si">{</span><span class="n">gf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;added_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">water_depth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Finite depth </span><span class="si">{</span><span class="n">gf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;radiation_damping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">water_depth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Infinite depth </span><span class="si">{</span><span class="n">gf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;radiation_damping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">water_depth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Finite depth </span><span class="si">{</span><span class="n">gf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Added mass&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Radiation damping&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="c9-use-a-custom-green-function">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">C9. Use a custom Green function</a><a class="headerlink" href="#c9-use-a-custom-green-function" title="Link to this heading">¶</a></h2>
<p>This is an example of how to implement a custom Green function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">dot</span><span class="p">,</span> <span class="n">pi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cpt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capytaine.green_functions.abstract_green_function</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractGreenFunction</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyGreenFunction</span><span class="p">(</span><span class="n">AbstractGreenFunction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An example of a custom routine to evaluate the Green function.&quot;&quot;&quot;</span>

    <span class="n">floating_point_precision</span> <span class="o">=</span> <span class="s2">&quot;float64&quot;</span>  <span class="c1"># Optional, could allow for RAM usage optimisations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mesh1</span><span class="p">,</span>
        <span class="n">mesh2</span><span class="p">,</span>
        <span class="n">free_surface</span><span class="p">,</span>
        <span class="n">water_depth</span><span class="p">,</span>
        <span class="n">wavenumber</span><span class="p">,</span>
        <span class="n">adjoint_double_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">early_dot_product</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The main method that needs to be implemented in the class.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">adjoint_double_layer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;MyGreenFunction only implements the adjoint double layer&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">free_surface</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">and</span> <span class="n">water_depth</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;MyGreenFunction only implements the case without a free surface&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Initialize the matrices</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh1</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">,</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">early_dot_product</span><span class="p">:</span>
            <span class="n">gradient_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">mesh1</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">,</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradient_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">mesh1</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">,</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gradient_shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh1</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh2</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">):</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">faces_areas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="c1"># Approximation of the integral of the 1/r Green</span>
                    <span class="c1"># function over the panel by taking the integral over a</span>
                    <span class="c1"># circle of same center and same area.</span>
                    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">area</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mesh1</span> <span class="ow">is</span> <span class="n">mesh2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">early_dot_product</span><span class="p">:</span>
                            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">faces_normals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">early_dot_product</span><span class="p">:</span>
                            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The integral on the face is computed using the value</span>
                    <span class="c1"># at the center of the face.</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">faces_centers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">faces_centers</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

                    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">area</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                    <span class="n">gradient_rankine</span> <span class="o">=</span> <span class="n">area</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">early_dot_product</span><span class="p">:</span>
                        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradient_rankine</span><span class="p">,</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">faces_normals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gradient_rankine</span>

        <span class="k">return</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span>


<span class="c1"># Define a solver using the Green function above.</span>
<span class="n">custom_solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span><span class="n">green_function</span><span class="o">=</span><span class="n">MyGreenFunction</span><span class="p">())</span>
<span class="n">default_solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">()</span>  <span class="c1"># for comparison</span>

<span class="c1"># Example of a problem</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mf">1.4</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="p">(</span>
    <span class="n">mesh</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">mesh_sphere</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">dofs</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">rigid_body_dofs</span><span class="p">(</span><span class="n">rotation_center</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
<span class="p">)</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">RadiationProblem</span><span class="p">(</span>
    <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">free_surface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">water_depth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">radiating_dof</span><span class="o">=</span><span class="s2">&quot;Surge&quot;</span>
<span class="p">)</span>

<span class="n">custom_result</span> <span class="o">=</span> <span class="n">custom_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
<span class="n">default_result</span> <span class="o">=</span> <span class="n">default_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Added mass:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Analytical value: </span><span class="si">{</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">rho</span><span class="o">*</span><span class="n">radius</span><span class="o">**</span><span class="mi">3</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Custom solver:    </span><span class="si">{</span><span class="n">custom_result</span><span class="o">.</span><span class="n">added_masses</span><span class="p">[</span><span class="s1">&#39;Surge&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Default solver:   </span><span class="si">{</span><span class="n">default_result</span><span class="o">.</span><span class="n">added_masses</span><span class="p">[</span><span class="s1">&#39;Surge&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># The analytical solution is known for this particular test case.</span>
<span class="c1"># The custom solver might be more accurate. That is probably a coincidence.</span>
<span class="c1"># Both should converge to the same solution when the mesh is refined.</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timer:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Custom solver:  </span><span class="si">{</span><span class="n">custom_solver</span><span class="o">.</span><span class="n">timer</span><span class="p">[</span><span class="s1">&#39;  Green function&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Default solver: </span><span class="si">{</span><span class="n">default_solver</span><span class="o">.</span><span class="n">timer</span><span class="p">[</span><span class="s1">&#39;  Green function&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="c10-implementation-of-a-gpu-custom-linear-solver">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">C10. Implementation of a GPU Custom Linear Solver</a><a class="headerlink" href="#c10-implementation-of-a-gpu-custom-linear-solver" title="Link to this heading">¶</a></h2>
<p>This is an example of how to implement a custom solver for linear systems that
leverages your computers’s GPU, here with PyTorch.
Your mileage may vary as performance will vary wildly across different hardware.
Please also note that you are expected to already be familiar with GPU
frameworks and have a working setup to use this; Capytaine’s developers can
offer no support for GPU issues unrelated to Capytaine.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">capytaine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cpt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="n">reference_cpu_solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">()</span>


<span class="c1"># A simple implementation of a linear solver on GPU using PyTorch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_solver_on_GPU</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">A_on_GPU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">b_on_GPU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A_on_GPU</span><span class="p">,</span> <span class="n">b_on_GPU</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">naive_gpu_solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span>
    <span class="n">engine</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">BasicMatrixEngine</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="n">linear_solver_on_GPU</span><span class="p">)</span>
<span class="p">)</span>


<span class="c1"># Alternatively, an optimization of the above to avoid doing the same GPU</span>
<span class="c1"># transfer and LU factorization twice</span>
<span class="n">latest_A</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">latest_LU_decomp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">def</span><span class="w"> </span><span class="nf">lu_linear_solver_with_cache_on_GPU</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">latest_A</span><span class="p">,</span> <span class="n">latest_LU_decomp</span>
    <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">latest_A</span><span class="p">:</span>
        <span class="n">latest_A</span> <span class="o">=</span> <span class="n">A</span>
        <span class="n">A_on_GPU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">latest_LU_decomp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_factor</span><span class="p">(</span><span class="n">A_on_GPU</span><span class="p">)</span>
    <span class="n">b_on_GPU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Reshaping because `torch.linalg.lu_solve` wants a column vector on the</span>
    <span class="c1"># right-hand-side (unlike `torch.linalg.solve`).</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span><span class="o">*</span><span class="n">latest_LU_decomp</span><span class="p">,</span> <span class="n">b_on_GPU</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">gpu_solver</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">BEMSolver</span><span class="p">(</span>
    <span class="n">engine</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">BasicMatrixEngine</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="n">lu_linear_solver_with_cache_on_GPU</span><span class="p">)</span>
<span class="p">)</span>


<span class="c1">###############</span>
<span class="c1">#  Benchmark  #</span>
<span class="c1">###############</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">mesh_sphere</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">immersed_part</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">nb_faces</span><span class="p">,</span> <span class="s2">&quot;faces&quot;</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">FloatingBody</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dofs</span><span class="o">=</span><span class="n">cpt</span><span class="o">.</span><span class="n">rigid_body_dofs</span><span class="p">())</span>

<span class="n">test_matrix</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;omega&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="s2">&quot;radiating_dof&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">dofs</span><span class="p">),</span>
        <span class="s2">&quot;water_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">ds1</span> <span class="o">=</span> <span class="n">reference_cpu_solver</span><span class="o">.</span><span class="n">fill_dataset</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">ds2</span> <span class="o">=</span> <span class="n">naive_gpu_solver</span><span class="o">.</span><span class="n">fill_dataset</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">ds3</span> <span class="o">=</span> <span class="n">gpu_solver</span><span class="o">.</span><span class="n">fill_dataset</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slightly faster GPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>


<span class="c1"># Check outputs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ds1</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">ds1</span><span class="o">.</span><span class="n">added_mass</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">radiating_dof</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">,</span> <span class="n">influenced_dof</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ds2</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">ds2</span><span class="o">.</span><span class="n">added_mass</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">radiating_dof</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">,</span> <span class="n">influenced_dof</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ds3</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">ds3</span><span class="o">.</span><span class="n">added_mass</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">radiating_dof</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">,</span> <span class="n">influenced_dof</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">capytaine</a></h1>



<p class="blurb">a Python-based linear potential flow BEM solver</p>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Features</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/index.html">User manual</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example scripts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="A_beginners_cookbook.html">Beginner’s cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="B_intermediate_cookbook.html">Intermediate cookbook</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Advanced cookbook</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer_manual/index.html">Developer manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../theory_manual/index.html">Theory manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Example scripts</a><ul>
      <li>Previous: <a href="B_intermediate_cookbook.html" title="previous chapter">Intermediate cookbook</a></li>
      <li>Next: <a href="../developer_manual/index.html" title="next chapter">Developer manual</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Matthieu Ancellin.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/examples/C_advanced_cookbook.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>